---
title: "Spring Cloud åŸç”Ÿä¸­é—´ä»¶"
date: 2025-06-09T13:57:23+08:00
draft: false
description: "Spring Cloudä¸­é—´ä»¶çš„ä»‹ç»"
tags: ["Java", "Spring Cloud"]
---

ğŸ“ [ä»£ç è®°å½•](https://github.com/RexTechie/cloud2024)

## Consulï¼ˆæœåŠ¡æ³¨å†Œä¸å‘ç° + åˆ†å¸ƒå¼é…ç½®ç®¡ç†ï¼‰

> æ‹¥æœ‰æœåŠ¡æ²»ç†åŠŸèƒ½ï¼Œå®ç°å¾®æœåŠ¡ä¹‹é—´çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°
>
> âŒä¸åœ¨ä½¿ç”¨Eurekaï¼š1. åœæ›´è¿›ç»´ 2. æ³¨å†Œä¸­å¿ƒç‹¬ç«‹ä¸”å’Œå¾®æœåŠ¡åŠŸèƒ½è§£è€¦

[Consulå®˜ç½‘](https://developer.hashicorp.com/consul)

[Springå®˜æ–¹ä»‹ç»](http://spring.io/projects/spring-cloud-consul)

### ä¸‰ä¸ªæ³¨å†Œä¸­å¿ƒåŒºåˆ«

| ç»„ä»¶å    | è¯­è¨€ | CAP  | æœåŠ¡å¥åº·æ£€æŸ¥ | å¯¹å¤–æš´éœ²æ¥å£ | Spring Cloudé›†æˆ |
| --------- | ---- | ---- | ------------ | ------------ | ---------------- |
| Eureka    | Java | AP   | å¯é…æ”¯æŒ     | HTTP         | å·²é›†æˆ           |
| Consul    | Go   | CP   | æ”¯æŒ         | HTTP/DNS     | å·²é›†æˆ           |
| Zookeeper | Java | CP   | æ”¯æŒ         | å®¢æˆ·ç«¯       | å·²é›†æˆ           |
| Nacos     | Java | AP   | æ”¯æŒ         | å®¢æˆ·ç«¯       | å·²é›†æˆ           |

#### CAP

> ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­çš„ä¸¤ä¸ªå±æ€§ã€‚

- Consistency: å¼ºä¸€è‡´æ€§ï¼Œæ¯æ¬¡è¯»å–éƒ½èƒ½è·å–åˆ°æœ€è¿‘ä¸€æ¬¡æˆåŠŸå†™å…¥çš„æ•°æ®ã€‚
- Availablity: å¯ç”¨æ€§ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåœ¨æœ‰é™æ—¶é—´å†…è¿”å›ç»“æœï¼Œæ— è®ºç»“æœæ˜¯å¦ä¸ºæœ€æ–°ã€‚
- Partition tolerance: åˆ†åŒºå®¹é”™æ€§ï¼Œç³»ç»Ÿåœ¨é‡åˆ°ç½‘ç»œåˆ†åŒºï¼ˆèŠ‚ç‚¹ä¹‹é—´æ— æ³•é€šä¿¡ï¼‰æ—¶ä»èƒ½ç»§ç»­è¿ä½œã€‚ï¼ˆå¿…é¡»æœ‰ï¼‰

ç»å…¸CAPï¼š

- APï¼ˆEurakeï¼‰ï¼šå½“ç½‘ç»œåˆ†åŒºå‡ºç°åï¼Œä¸ºäº†ä¿è¯å¯ç”¨æ€§ï¼Œç³»ç»ŸBå¯ä»¥è¿”å›æ—§å€¼ï¼Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚

  ![CAP_AP](/images/20250612214547.png)

- CPï¼šå½“ç½‘ç»œåˆ†åŒºå‡ºç°åï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œç³»ç»Ÿè¿”å›é”™è¯¯ä¿¡æ¯ã€‚

  ![CAP_CP](/images/20250612214611.png)

å½“æ•°æ®å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œè™½ç„¶A, Bä¸Šçš„æ³¨å†Œä¿¡æ¯ä¸å®Œå…¨ç›¸åŒï¼Œä½†æ¯ä¸ªEurekaèŠ‚ç‚¹ä¾ç„¶èƒ½å¤Ÿæ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™ä¼šå‡ºç°æŸ¥è¯¢æœåŠ¡ä¿¡æ¯æ—¶å¦‚æœè¯·æ±‚AæŸ¥ä¸åˆ°ï¼Œä½†è¯·æ±‚Bå°±èƒ½æŸ¥åˆ°ã€‚å¦‚æ­¤ä¿è¯äº†å¯ç”¨æ€§ä½†ç‰ºç‰²äº†ä¸€è‡´æ€§ç»“è®ºï¼šè¿èƒŒäº†ä¸€è‡´æ€§Cçš„è¦æ±‚ï¼Œåªæ»¡è¶³å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™ï¼Œå³AP

å½“ç½‘ç»œåˆ†åŒºå‡ºç°åï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œ**å°±å¿…é¡»æ‹’æ¥è¯·æ±‚**ï¼Œå¦åˆ™æ— æ³•ä¿è¯ä¸€è‡´æ€§ï¼ŒConsul éµå¾ªCAPåŸç†ä¸­çš„CPåŸåˆ™ï¼Œä¿è¯äº†å¼ºä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä¸”ä½¿ç”¨çš„æ˜¯Raftç®—æ³•ï¼Œæ¯”zookeeperä½¿ç”¨çš„Paxosç®—æ³•æ›´åŠ ç®€å•ã€‚è™½ç„¶ä¿è¯äº†å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯å¯ç”¨æ€§å°±ç›¸åº”ä¸‹é™äº†ï¼Œä¾‹å¦‚æœåŠ¡æ³¨å†Œçš„æ—¶é—´ä¼šç¨é•¿ä¸€äº›ï¼Œå› ä¸º Consul çš„ raft åè®®è¦æ±‚å¿…é¡»è¿‡åŠæ•°çš„èŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸæ‰è®¤ä¸ºæ³¨å†ŒæˆåŠŸ ï¼›åœ¨leaderæŒ‚æ‰äº†ä¹‹åï¼Œé‡æ–°é€‰ä¸¾å‡ºleaderä¹‹å‰ä¼šå¯¼è‡´Consul æœåŠ¡ä¸å¯ç”¨ã€‚ç»“è®ºï¼šè¿èƒŒäº†å¯ç”¨æ€§Açš„è¦æ±‚ï¼Œåªæ»¡è¶³ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™ï¼Œå³CP

### ä½¿ç”¨

```bash
./consul --version # æŸ¥çœ‹ç‰ˆæœ¬å·
./consul agent -dev # å¼€å‘æ¨¡å¼å¯åŠ¨ http://localhost:8500

```

## LoadBalanceï¼ˆæœåŠ¡è°ƒç”¨å¤æ‚å‡è¡¡ï¼‰

> è´Ÿè½½å‡è¡¡ï¼šå¹³æ‘Šè¯·æ±‚ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
>
> Spring-cloud-starter-loadbalancerï¼šspringå®˜æ–¹æä¾›çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ï¼Œåœ¨SpringCloud-commonsä¸­ï¼Œç”¨æ¥æ›¿ä»£ä»¥å‰çš„Ribbonï¼Œæ”¯æŒRestTemplateã€Web Fluxã€‚
>
> å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡åŒºåˆ«ï¼šæœåŠ¡å™¨ç«¯å¦‚Nginxï¼Œå°†å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚åˆ°é€šè¿‡æœåŠ¡å™¨ç«¯éƒ¨ç½²çš„Nginxï¼Œè½¬å‘åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Šã€‚LoadBlanceæœ¬åœ°è´Ÿè½½å‡è¡¡ï¼Œè°ƒç”¨å¾®æœåŠ¡æ¥å£æ—¶ï¼Œåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–ä¿¡æ¯æœåŠ¡åˆ—è¡¨ä¹‹åç¼“å­˜åˆ°JVMæœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç°RPCè¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚

[Springå®˜æ–¹ä»‹ç»](https://docs.spring.io/spring-cloud-commons/reference/spring-cloud-commons/loadbalancer.html)

### è´Ÿè½½å‡è¡¡ç®—æ³•

å®ç°ReactiveLoadBalanceræ¥å£ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯RoundRobinLoadBalancerã€‚

[å®˜æ–¹å¯¹è´Ÿè½½å‡è¡¡ç®—æ³•çš„ä»‹ç»](https://docs.spring.io/spring-cloud-commons/reference/spring-cloud-commons/loadbalancer.html#switching-between-the-load-balancing-algorithms)

- RoundRobinLoadBalancer: è½®è¯¢
- RandomLoadBalancer: éšæœº

## OpenFeignï¼ˆæœåŠ¡è°ƒç”¨å¤æ‚å‡è¡¡ï¼‰

> Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼webæœåŠ¡å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ›¿ä»£RestTemplateï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªRestæ¥å£å¹¶åœ¨è¯¥æ¥å£ä¸Šæ·»åŠ æ³¨è§£@FeignClientã€‚
>
> OpenFeignåŸºæœ¬ä¸Šå°±æ˜¯å½“å‰å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨çš„äº‹å®æ ‡å‡†ã€‚
>
> å¯ä»¥ç»“åˆLoadBalancerå®ç°è´Ÿè½½å‡è¡¡ï¼Œç»“åˆSentinelå®ç°ç†”æ–­é™çº§ã€‚

[Springå®˜æ–¹ä»‹ç»](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html) [Github](https://github.com/spring-cloud/spring-cloud-openfeign)

### è¶…æ—¶æ§åˆ¶

[è¶…æ—¶æ§åˆ¶è¯´æ˜](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#timeout-handling)

- connectTimeout: è¿æ¥è¶…æ—¶æ—¶é—´
- readTimeout: è¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´æ˜¯60s

### é‡è¯•æœºåˆ¶

[é‡è¯•æœºåˆ¶è¯´æ˜](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#spring-cloud-feign-overriding-defaults)

é»˜è®¤æƒ…å†µä¸‹ä¼šåˆ›å»ºRetry.NEVER_RETRYç±»å‹çš„Retryçš„beanï¼Œè¿™å°†ç¦ç”¨é‡è¯•ï¼Œè¿™ç§é‡è¯•è¡Œä¸ºä¸Feigné»˜è®¤è¡Œä¸ºä¸åŒï¼Œä»–ä¼šè‡ªåŠ¨é‡è¯•IOExceptionsï¼Œå°†å®ƒä»¬è§†ä¸ºç½‘ç»œç›¸å…³çš„ç¬æ€å¼‚å¸¸ï¼Œä»¥åŠä»ErrorDecoderæŠ›å‡ºçš„ä»»ä½•RetryableExceptionã€‚

### é»˜è®¤HTTPClientä¿®æ”¹

[é»˜è®¤HTTPClientä¿®æ”¹è¯´æ˜](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#spring-cloud-feign-overriding-defaults)

å¦‚æœä¸åšç‰¹æ®Šé…ç½®ï¼ŒOpenFeigné»˜è®¤ä½¿ç”¨JDKè‡ªå¸¦çš„HttpURLConnectionå‘é€HTTPè¯·æ±‚ï¼Œ

ç”±äºé»˜è®¤HttpURLConnectionæ²¡æœ‰è¿æ¥æ± ã€æ€§èƒ½å’Œæ•ˆç‡æ¯”è¾ƒä½ ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤ï¼Œæ— æ³•å‘æŒ¥æœ€å¤§æ€§èƒ½ï¼Œæ•…ä½¿ç”¨Apachçš„HTTPClient 5æ›¿æ¢é»˜è®¤HTTPURLConnectionã€‚

âš ï¸æ³¨æ„ï¼šhttpclientçš„ç‰ˆæœ¬å¯¹é½

### è¯·æ±‚/å“åº”å‹ç¼©

[è¯·æ±‚/å“åº”å‹ç¼©è¯´æ˜](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#feign-request-response-compression)

Spring Cloud OpenFeignæ”¯æŒå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡ŒGZIPå‹ç¼©ï¼Œä»¥å‡å°‘é€šä¿¡è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŸè€—ã€‚

### æ—¥å¿—æ‰“å°åŠŸèƒ½

[æ—¥å¿—æ‰“å°åŠŸèƒ½è¯´æ˜](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#feign-logging)

Feign æä¾›äº†æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œ

æ—¥å¿—çº§åˆ«ï¼š

- NONEï¼šé»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—ï¼›
- BASICï¼šä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ï¼›
- HEADERSï¼šé™¤äº† BASIC ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ï¼›
- FULLï¼šé™¤äº† HEADERS ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®

## CircuitBreakerï¼ˆæ–­è·¯å™¨ï¼‰

âš ï¸è¾ƒä¸ºç¹çï¼Œèµ„æ–™å°‘ï¼Œä¸é€‚åˆè‡ªå­¦ï¼Œé¢è¯•å¿…è€ƒ

> è§£å†³æœåŠ¡é›ªå´©é—®é¢˜ï¼Œå¯¹äºæœ‰é—®é¢˜çš„èŠ‚ç‚¹ï¼Œå¿«é€Ÿç†”æ–­ï¼ˆå¿«é€Ÿè¿”å›å¤±è´¥å¤„ç†æˆ–è€…è¿”å›é»˜è®¤å…œåº•æ•°æ®ã€æœåŠ¡é™çº§ã€‘ï¼‰
>
> â€œæ–­è·¯å™¨â€æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”(FallBack)ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ã€ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚
>
> å½“ä¸€ä¸ªç»„ä»¶æˆ–æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼ŒCircuitBreakerä¼šè¿…é€Ÿåˆ‡æ¢åˆ°å¼€æ”¾OPENçŠ¶æ€(ä¿é™©ä¸è·³é—¸æ–­ç”µ)ï¼Œé˜»æ­¢è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ä»è€Œé¿å…æ›´å¤šçš„è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ã€‚è¿™å¯ä»¥å‡å°‘å¯¹è¯¥ç»„ä»¶æˆ–æœåŠ¡çš„è´Ÿè½½ï¼Œé˜²æ­¢è¯¥ç»„ä»¶æˆ–æœåŠ¡è¿›ä¸€æ­¥å´©æºƒï¼Œå¹¶ä½¿æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æ­£å¸¸è¿è¡Œã€‚åŒæ—¶ï¼ŒCircuitBreakerè¿˜å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œä»è€Œé¿å…å•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚

[Springå®˜æ–¹ä»‹ç»](https://spring.io/projects/spring-cloud-circuitbreaker)

Spring Cloudæä¾›çš„ä¸¤ä¸ªå®ç°ç±»ï¼šResilience4jã€Spring Retry

### Resilience4j

[Resilience4jå®˜ç½‘](https://github.com/resilience4j/resilience4j)

> Resilience4j æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®¹é”™åº“ï¼Œä¸“ä¸ºå‡½æ•°å¼ç¼–ç¨‹è®¾è®¡ã€‚Resilience4j æä¾›äº†é«˜é˜¶å‡½æ•°ï¼ˆè£…é¥°å™¨ï¼‰ï¼Œå¯ä»¥å¢å¼ºä»»ä½•å‡½æ•°å¼æ¥å£ã€lambda è¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨ï¼Œæ·»åŠ æ–­è·¯å™¨ã€é€Ÿç‡é™åˆ¶å™¨ã€é‡è¯•æˆ–èˆ±å£ã€‚æ‚¨å¯ä»¥åœ¨ä»»ä½•å‡½æ•°å¼æ¥å£ã€lambda è¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨ä¸Šå †å å¤šä¸ªè£…é¥°å™¨ã€‚ä¼˜ç‚¹æ˜¯å¯ä»¥è‡ªç”±é€‰æ‹©æ‰€éœ€çš„è£…é¥°å™¨ï¼Œè€Œä¸éœ€è¦å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚

#### æ–­è·¯ï¼ˆCircuit Breakerï¼‰

##### æ–­è·¯å™¨çŠ¶æ€

- OPEN
- CLOSED
- HALF_OPEN
- DISABLED(ç‰¹æ®ŠçŠ¶æ€)
- FORCED_OPEN(ç‰¹æ®ŠçŠ¶æ€)

##### 3å¤§çŠ¶æ€ä¹‹é—´çš„è½¬æ¢

![å®˜æ–¹çŠ¶æ€è½¬æ¢å›¾](https://files.readme.io/39cdd54-state_machine.jpg)

- å½“ç†”æ–­å™¨å…³é—­æ—¶ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ç†”æ–­å™¨
  - å¤±è´¥ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼Œç†”æ–­å™¨å°±ä¼šä»CLOSEDè½¬åˆ°OPENï¼Œè¿™æ—¶æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»
  - å½“ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œç†”æ–­å™¨ä¼šä»OPENå˜ä¸ºHALF_OPENï¼Œè¿™æ—¶æœ‰ä¸€å®šæ•°é‡çš„è¯·æ±‚ä¼šè¢«æ”¾å…¥ï¼Œå¹¶é‡æ–°è®¡ç®—å¤±è´¥ç‡  
  - å¦‚æœå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™å˜ä¸ºOPENçŠ¶æ€ï¼Œå¦‚æœå¤±è´¥ç‡ä½äºé˜ˆå€¼ï¼Œåˆ™å˜ä¸ºCLOSEDçŠ¶æ€
- æ–­è·¯å™¨ä½¿ç”¨æ»‘åŠ¨çª—å£æ¥å­˜å‚¨å’Œç»Ÿè®¡è°ƒç”¨çš„ç»“æœ
  - åŸºäºè®¿é—®æ•°é‡çš„æ»‘åŠ¨çª—å£ï¼šç»Ÿè®¡äº†æœ€è¿‘Næ¬¡è°ƒç”¨çš„è¿”å›ç»“æœ
  - åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£ï¼šç»Ÿè®¡äº†æœ€è¿‘Nç§’çš„è°ƒç”¨è¿”å›ç»“æœ
- ç‰¹æ®ŠçŠ¶æ€
  - è¿™ä¸¤ä¸ªçŠ¶æ€ä¸ä¼šç”Ÿæˆç†”æ–­æ—¶é—´ï¼Œå¹¶ä¸”ä¸å›è®°å½•äº‹ä»¶çš„æˆåŠŸæˆ–å¤±è´¥
  - é€€å‡ºè¿™ä¸¤ä¸ªçŠ¶æ€çš„å”¯ä¸€æ–¹æ³•æ˜¯è§¦å‘çŠ¶æ€è½¬æ¢æˆ–è€…ç†”æ–­å™¨

##### é…ç½®

| **failure-rate-threshold**                       | **ä»¥ç™¾åˆ†æ¯”é…ç½®å¤±è´¥ç‡å³°å€¼**                                   |
| ------------------------------------------------ | ------------------------------------------------------------ |
| **sliding-window-type**                          | **æ–­è·¯å™¨çš„æ»‘åŠ¨çª—å£æœŸç±»å‹: åŸºäºâ€œæ¬¡æ•°â€ï¼ˆCOUNT_BASEDï¼‰ã€â€œæ—¶é—´â€ï¼ˆTIME_BASEDï¼‰è¿›è¡Œç†”æ–­ï¼Œé»˜è®¤æ˜¯COUNT_BASEDã€‚** |
| **sliding-window-size**                          | **è‹¥COUNT_BASEDï¼Œåˆ™Næ¬¡è°ƒç”¨ä¸­æœ‰failure-rate-threshold%å¤±è´¥ï¼ˆå³5æ¬¡ï¼‰æ‰“å¼€ç†”æ–­æ–­è·¯å™¨ï¼›è‹¥ä¸ºTIME_BASEDåˆ™ï¼Œæ­¤æ—¶è¿˜æœ‰é¢å¤–çš„ä¸¤ä¸ªè®¾ç½®å±æ€§ï¼Œå«ä¹‰ä¸ºï¼šåœ¨Nç§’å†…ï¼ˆsliding-window-sizeï¼‰100%ï¼ˆslow-call-rate-thresholdï¼‰çš„è¯·æ±‚è¶…è¿‡Nç§’ï¼ˆslow-call-duration-thresholdï¼‰æ‰“å¼€æ–­è·¯å™¨ã€‚** |
| **slowCallRateThreshold**                        | **ä»¥ç™¾åˆ†æ¯”çš„æ–¹å¼é…ç½®ï¼Œæ–­è·¯å™¨æŠŠè°ƒç”¨æ—¶é—´å¤§äºslowCallDurationThresholdçš„è°ƒç”¨è§†ä¸ºæ…¢è°ƒç”¨ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºç­‰äºå³°å€¼æ—¶ï¼Œæ–­è·¯å™¨å¼€å¯ï¼Œå¹¶è¿›å…¥æœåŠ¡é™çº§ã€‚** |
| **slowCallDurationThreshold**                    | **é…ç½®è°ƒç”¨æ—¶é—´çš„å³°å€¼ï¼Œé«˜äºè¯¥å³°å€¼çš„è§†ä¸ºæ…¢è°ƒç”¨ã€‚**             |
| **permitted-number-of-calls-in-half-open-state** | **è¿è¡Œæ–­è·¯å™¨åœ¨HALF_OPENçŠ¶æ€ä¸‹æ—¶è¿›è¡ŒNæ¬¡è°ƒç”¨ï¼Œå¦‚æœæ•…éšœæˆ–æ…¢é€Ÿè°ƒç”¨ä»ç„¶é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨å†æ¬¡è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚** |
| **minimum-number-of-calls**                      | **åœ¨æ¯ä¸ªæ»‘åŠ¨çª—å£æœŸæ ·æœ¬æ•°ï¼Œé…ç½®æ–­è·¯å™¨è®¡ç®—é”™è¯¯ç‡æˆ–è€…æ…¢è°ƒç”¨ç‡çš„æœ€å°è°ƒç”¨æ•°ã€‚æ¯”å¦‚è®¾ç½®ä¸º5æ„å‘³ç€ï¼Œåœ¨è®¡ç®—æ•…éšœç‡ä¹‹å‰ï¼Œå¿…é¡»è‡³å°‘è°ƒç”¨5æ¬¡ã€‚å¦‚æœåªè®°å½•äº†4æ¬¡ï¼Œå³ä½¿4æ¬¡éƒ½å¤±è´¥äº†ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šè¿›å…¥åˆ°æ‰“å¼€çŠ¶æ€ã€‚** |
| **wait-duration-in-open-state**                  | **ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´**                      |

ä¾‹å­ï¼š

6æ¬¡è®¿é—®ä¸­å½“æ‰§è¡Œæ–¹æ³•çš„å¤±è´¥ç‡è¾¾åˆ°50%æ—¶CircuitBreakerå°†è¿›å…¥å¼€å¯OPENçŠ¶æ€(ä¿é™©ä¸è·³é—¸æ–­ç”µ)æ‹’ç»æ‰€æœ‰è¯·æ±‚ã€‚

ç­‰å¾…5ç§’åï¼ŒCircuitBreakerå°†è‡ªåŠ¨ä»å¼€å¯OPENçŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€HALF_OPENçŠ¶æ€ï¼Œå…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸ã€‚

å¦‚è¿˜æ˜¯å¼‚å¸¸CircuitBreakerå°†é‡æ–°è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼›å¦‚æ­£å¸¸å°†è¿›å…¥å…³é—­CLOSEé—­åˆçŠ¶æ€æ¢å¤æ­£å¸¸å¤„ç†è¯·æ±‚ã€‚

```yaml
failure-rate-threshold: 50 # è®¾ç½®50%çš„å¤±è´¥ç‡é˜ˆå€¼ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†æ¯”CircuitBreakerå˜ä¸ºopen
sliding-window-type: COUNT_BASED # æ»‘åŠ¨çª—å£çš„ç±»å‹
sliding-window-size: 6 # æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œå•ä½ä¸ºè¯·æ±‚æ•°
minimum-number-of-calls: 6 # æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬ï¼ˆæ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸï¼‰
automatic-transition-from-open-to-half-open-enabled: true # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä»å¼€å¯åˆ°åŠå¼€å¯çŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸ºfalse
wait-duration-in-open-state: 5s # ä»OPENåˆ°HALF_OPENçŠ¶æ€çš„ç­‰å¾…æ—¶é—´
permitted-number-of-calls-in-half-open-state: 2 # åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10.
```

```yaml
failure-rate-threshold: 50 # è®¾ç½®50%çš„å¤±è´¥ç‡é˜ˆå€¼ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†æ¯”CircuitBreakerå˜ä¸ºopen
slow-call-duration-threshold: 2s # æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼ï¼Œé«˜äºæ­¤æ—¶é—´çš„è°ƒç”¨å°†è¢«è§†ä¸ºæ…¢è°ƒç”¨å¹¶å¢åŠ è°ƒç”¨æ¯”ä¾‹ã€‚
slow-call-rate-threshold: 30 # æ…¢è°ƒç”¨ç™¾åˆ†æ¯”é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤ç™¾åˆ†æ¯”çš„æ…¢è°ƒç”¨å°†è§¦å‘æ–­è·¯å™¨ã€‚
sliding-window-type: TIME_BASED
sliding-window-size: 2 # æ»‘åŠ¨çª—å£çš„å¤§å°é…ç½®ï¼Œé…ç½®TIME_BASEDè¡¨ç¤º2ç§’
minimum-number-of-calls: 2 # æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬ï¼ˆæ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸï¼‰
permitted-number-of-calls-in-half-open-state: 2 # åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10.
wait-duration-in-open-state: 5s # ä»OPENåˆ°HALF_OPENçŠ¶æ€çš„ç­‰å¾…æ—¶é—´
record-exceptions:
  - java.lang.Exception
```

#### èˆ±å£éš”ç¦»ï¼ˆBulkheadï¼‰

> ä¾èµ–éš”ç¦»&è´Ÿè½½ä¿æŠ¤ï¼šç”¨æ¥é™åˆ¶å¯¹äºä¸‹æ¸¸æœåŠ¡çš„æœ€å¤§å¹¶å‘çš„é™åˆ¶

[èˆ±å£éš”ç¦»è¯´æ˜](https://github.com/lmhmhl/Resilience4j-Guides-Chinese/blob/main/core-modules/bulkhead.md)

##### ä¸¤ç§éš”ç¦»æ–¹å¼

- ä¿¡å·é‡èˆ±å£ï¼ˆSemaphoreBulkheadï¼‰ï¼š
  - å½“ä¿¡å·é‡æœ‰ç©ºé—²æ—¶ï¼Œè¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚ä¼šç›´æ¥è·å–ä¿¡å·é‡å¹¶å¼€å§‹ä¸šåŠ¡å¤„ç†ã€‚
  - å½“ä¿¡å·é‡å…¨å¤‡å ç”¨æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒSemaphoreBulkheadæä¾›äº†ä¸€ä¸ªé˜»å¡è®¡æ—¶å™¨
    - å¦‚æœé˜»å¡çŠ¶æ€çš„è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…æ— æ³•è·å–åˆ°ä¿¡å·é‡åˆ™ç³»ç»Ÿä¼šæ‹’ç»è¿™äº›è¯·æ±‚ã€‚
    - è‹¥è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…è·å–åˆ°äº†ä¿¡å·é‡ï¼Œé‚£å°†ç›´æ¥è·å–ä¿¡å·é‡å¹¶æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†
- FixedThreadPoolBulkheadä½¿ç”¨äº†æœ‰ç•Œé˜Ÿåˆ—å’Œå›ºå®šå¤§å°çº¿ç¨‹æ± 
  - å½“çº¿ç¨‹æ± ä¸­å­˜åœ¨ç©ºé—²æ—¶ï¼Œåˆ™æ­¤æ—¶è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚å°†ç›´æ¥è¿›å…¥çº¿ç¨‹æ± å¼€å¯æ–°çº¿ç¨‹æˆ–ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚
  - å½“çº¿ç¨‹ä¸­æ— ç©ºé—²æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚è¿›å…¥ç­‰å¾…é˜Ÿåˆ—
    - è‹¥ç­‰å¾…é˜Ÿåˆ—ä»ç„¶æ— å‰©ä½™ç©ºé—´æ—¶æ¥ä¸‹æ¥çš„è¯·æ±‚å°†ç›´æ¥è¢«æ‹’ç»
    - åœ¨é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç­‰å¾…çº¿ç¨‹æ± å‡ºç°ç©ºé—²æ—¶ï¼Œå°†è¿›å…¥çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†
  - å¦ï¼ŒThreadPoolBulkheadåªå¯¹CompletableFutureæ–¹æ³•æœ‰æ•ˆï¼Œæ‰€ä»¥å¿…é¡»åˆ›å»ºè¿”å›CompletableFutureç±»å‹çš„æ–¹æ³•

#### é€Ÿç‡é™åˆ¶ï¼ˆRate Limiterï¼‰

[é€Ÿç‡é™åˆ¶è¯´æ˜](https://github.com/lmhmhl/Resilience4j-Guides-Chinese/blob/main/core-modules/ratelimiter.md)

##### é™æµç®—æ³•

- æ¼æ–—ç®—æ³•ï¼ˆLeaky Bucketï¼‰
  - ä¸€ä¸ªå›ºå®šå®¹é‡çš„æ¼æ¡¶ï¼ŒæŒ‰ç…§è®¾å®šå¸¸é‡å›ºå®šé€Ÿç‡æµå‡ºæ°´æ»´ï¼Œç±»ä¼¼åŒ»é™¢æ‰“åŠé’ˆï¼Œä¸ç®¡ä½ æºå¤´æµé‡å¤šå¤§ï¼Œæˆ‘è®¾å®šåŒ€é€Ÿæµå‡ºã€‚
  - å¦‚æœæµå…¥æ°´æ»´è¶…å‡ºäº†æ¡¶çš„å®¹é‡ï¼Œåˆ™æµå…¥çš„æ°´æ»´å°†ä¼šæº¢å‡ºäº†(è¢«ä¸¢å¼ƒ)ï¼Œè€Œæ¼æ¡¶å®¹é‡æ˜¯ä¸å˜çš„ã€‚
  - ç¼ºç‚¹ï¼šå¯¹äºå­˜åœ¨çªå‘ç‰¹æ€§çš„æµé‡æ¥è¯´ç¼ºä¹æ•ˆç‡ã€‚
- **ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰**
  - Spring Cloud é»˜è®¤ä½¿ç”¨çš„ç®—æ³•
  - å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œå…ˆåˆ¤æ–­æ¡¶ç©ºä¸ç©º
    - ä»¤ç‰Œæ¡¶ç®—æ³•ä¼šåŒ€é€Ÿçš„æ·»åŠ ä»¤ç‰Œè‡³ä»¤ç‰Œæ¡¶ä¸­ï¼Œæ¡¶å¯å®¹çº³ä»¤ç‰Œçš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚
    - ç”¨æˆ·æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œå…ˆæ£€æŸ¥æ¡¶æ˜¯å¦ä¸ºç©ºã€‚è‹¥æ¡¶ç©ºï¼Œåˆ™ä¸¢å¼ƒè¯·æ±‚ï¼›è‹¥æ¡¶ä¸ç©ºï¼Œåˆ™ç”³è¯·è·å¾—ä»¤ç‰Œï¼Œè·å¾—ä»¤ç‰Œåˆ™å¯æ’é˜Ÿè®©å¤„ç†å™¨å¤„ç†å½“å‰è¯·æ±‚
- æ»šåŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼ˆTumbling time windowï¼‰
  - å…è®¸å›ºå®šæ•°é‡çš„è¯·æ±‚è¿›å…¥(æ¯”å¦‚1ç§’å–4ä¸ªæ•°æ®ç›¸åŠ ï¼Œè¶…è¿‡25å€¼å°±over)è¶…è¿‡æ•°é‡å°±æ‹’ç»æˆ–è€…æ’é˜Ÿï¼Œç­‰ä¸‹ä¸€ä¸ªæ—¶é—´æ®µè¿›å…¥ã€‚
  - ç”±äºæ˜¯åœ¨ä¸€ä¸ªæ—¶é—´é—´éš”å†…è¿›è¡Œé™åˆ¶ï¼Œå¦‚æœç”¨æˆ·åœ¨ä¸Šä¸ªæ—¶é—´é—´éš”ç»“æŸå‰è¯·æ±‚ï¼ˆä½†æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼‰ï¼ŒåŒæ—¶åœ¨å½“å‰æ—¶é—´é—´éš”åˆšå¼€å§‹è¯·æ±‚ï¼ˆåŒæ ·æ²¡è¶…è¿‡é™åˆ¶ï¼‰ï¼Œåœ¨å„è‡ªçš„æ—¶é—´é—´éš”å†…ï¼Œè¿™äº›è¯·æ±‚éƒ½æ˜¯æ­£å¸¸çš„ã€‚
  - ç¼ºç‚¹ï¼šé—´éš”ä¸´ç•Œçš„ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚å°±ä¼šè¶…è¿‡ç³»ç»Ÿé™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿè¢«å‹å®ã€‚
- **æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼ˆSliding time windowï¼‰**
  - æ»‘åŠ¨çª—å£ç®—æ³•æ˜¯æŠŠå›ºå®šæ—¶é—´ç‰‡è¿›è¡Œåˆ’åˆ†å¹¶ä¸”éšç€æ—¶é—´ç§»åŠ¨ï¼Œç§»åŠ¨æ–¹å¼ä¸ºå¼€å§‹æ—¶é—´ç‚¹å˜ä¸ºæ—¶é—´åˆ—è¡¨ä¸­çš„ç¬¬2ä¸ªæ—¶é—´ç‚¹ï¼Œç»“æŸæ—¶é—´ç‚¹å¢åŠ ä¸€ä¸ªæ—¶é—´ç‚¹ã€‚
  - ä¸æ–­é‡å¤ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å·§å¦™çš„é¿å¼€è®¡æ•°å™¨çš„ä¸´ç•Œç‚¹çš„é—®é¢˜ã€‚

## Sleuth(Micrometer) + Zipkinï¼ˆåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼‰

> åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆDistributed Tracingï¼‰ï¼Œå°±æ˜¯å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚è¿˜åŸæˆè°ƒç”¨é“¾è·¯ï¼Œè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œæ€§èƒ½ç›‘æ§å¹¶å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚çš„è°ƒç”¨æƒ…å†µé›†ä¸­å±•ç¤ºã€‚æ¯”å¦‚å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„è€—æ—¶ã€è¯·æ±‚å…·ä½“åˆ°è¾¾å“ªå°æœºå™¨ä¸Šã€æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„è¯·æ±‚çŠ¶æ€ç­‰ç­‰ã€‚
>
> âš ï¸ Sleuthåœæ›´è¿›ç»´ï¼Œ Sleuthæ›¿ä»£æ–¹æ¡ˆMicrometer

[Micrometerå®˜æ–¹æ–‡æ¡£](https://micrometer.io/docs/tracing)

### åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªåŸç†

ä¸¤ä¸ªå…³é”®idï¼šTrack Idï¼ˆé“¾è·¯idï¼‰ã€Span Idï¼ˆèŠ‚ç‚¹idï¼‰ã€Parent Idï¼ˆçˆ¶çº§èŠ‚ç‚¹idï¼ŒSpan Idï¼‰

ä¸»è¦é€šè¿‡Span Idè®°å½•æ•´æ¡é“¾è·¯

### Dashboard

- [ZipKin](https://zipkin.io/)ï¼šç”±Twitterå…¬å¸å¼€æºï¼Œå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»çµ±ï¼Œç”¨äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®
  é¢˜ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚ç»“åˆspring-cloud-sleuthä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œé›†æˆæ–¹ä¾¿ï¼Œä½†æ˜¯åŠŸèƒ½è¾ƒ
  ç®€å•ã€‚
- [Cat](https://github.com/dianping/cat)ï¼šç”±å¤§ä¼—ç‚¹è¯„å¼€æºï¼ŒåŸºäºJavaå¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§åƒå°ï¼ŒåŒ…æ‹¬å®æ—¶åº”ç”¨ç›‘æ§ï¼Œä¸šåŠ¡ç›‘æ§ã€‚é›†æˆæ–¹æ¡ˆæ˜¯é€šè¿‡ä»£ç åŸ‹
  ç‚¹çš„æ–¹å¼æ¥å®ç°ç›‘æ§ï¼Œæ¯”å¦‚ï¼šæ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ç­‰ã€‚å¯¹ä»£ç çš„ä¾µå…¥æ€§å¾ˆå¤§ï¼Œé›†æˆæˆæœ¬è¾ƒé«˜ã€‚é£é™©è¾ƒå¤§ã€‚
- [Pinpoint](https://github.com/pinpoint-apm/pinpoint)ï¼šPinpointæ˜¯ä¸€æ¬¾å¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½
  å¼ºå¤§ï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚
- [Skywalking](https://skywalking.apache.org/)ï¼š SkyWalkingæ˜¯å›½äººå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤š
  ç§æ’ä»¶ï¼ŒUIåŠŸèƒ½è¾ƒå¼ºï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚

### æ•´åˆMicrometer Tracing

ç”±äºMicrometer Tracingæ˜¯ä¸€ä¸ªé—¨é¢å·¥å…·è‡ªèº«å¹¶æ²¡æœ‰å®ç°å®Œæ•´çš„é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œå…·ä½“çš„é“¾è·¯è¿½è¸ªå¦å¤–éœ€è¦å¼•å…¥çš„æ˜¯ç¬¬ä¸‰æ–¹é“¾è·¯è¿½è¸ªç³»ç»Ÿçš„ä¾èµ–ï¼š

- micrometer-tracing-bom  å¯¼å…¥é“¾è·¯è¿½è¸ªç‰ˆæœ¬ä¸­å¿ƒï¼Œä½“ç³»åŒ–è¯´æ˜
- micrometer-tracing  æŒ‡æ ‡è¿½è¸ª
- micrometer-tracing-bridge-brave  ä¸€ä¸ªMicrometeræ¨¡å—ï¼Œç”¨äºä¸åˆ†å¸ƒå¼è·Ÿè¸ªå·¥å…· Brave é›†æˆï¼Œä»¥æ”¶é›†åº”ç”¨ç¨‹åºçš„åˆ†å¸ƒå¼è·Ÿè¸ªæ•°æ®ã€‚Braveæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼è·Ÿè¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è·Ÿè¸ªè¯·æ±‚çš„æµè½¬ï¼Œå®ƒä½¿ç”¨ä¸€ç§ç§°ä¸º"è·Ÿè¸ªä¸Šä¸‹æ–‡"çš„æœºåˆ¶ï¼Œå°†è¯·æ±‚çš„è·Ÿè¸ªä¿¡æ¯å­˜å‚¨åœ¨è¯·æ±‚çš„å¤´éƒ¨ï¼Œç„¶åå°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæœåŠ¡ã€‚åœ¨æ•´ä¸ªè¯·æ±‚é“¾ä¸­ï¼ŒBraveä¼šå°†æ¯ä¸ªæœåŠ¡å¤„ç†è¯·æ±‚çš„æ—¶é—´å’Œå…¶ä»–ä¿¡æ¯å­˜å‚¨åˆ°è·Ÿè¸ªæ•°æ®ä¸­ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥äº†è§£æ•´ä¸ªè¯·æ±‚çš„è·¯å¾„å’Œæ€§èƒ½ã€‚
- micrometer-observation  ä¸€ä¸ªåŸºäºåº¦é‡åº“ Micrometerçš„è§‚æµ‹æ¨¡å—ï¼Œç”¨äºæ”¶é›†åº”ç”¨ç¨‹åºçš„åº¦é‡æ•°æ®ã€‚
- feign-micrometer  ä¸€ä¸ªFeign HTTPå®¢æˆ·ç«¯çš„Micrometeræ¨¡å—ï¼Œç”¨äºæ”¶é›†å®¢æˆ·ç«¯è¯·æ±‚çš„åº¦é‡æ•°æ®ã€‚
- zipkin-reporter-brave  ä¸€ä¸ªç”¨äºå°† Brave è·Ÿè¸ªæ•°æ®æŠ¥å‘Šåˆ°Zipkin è·Ÿè¸ªç³»ç»Ÿçš„åº“ã€‚
- è¡¥å……åŒ…ï¼šspring-boot-starter-actuator  SpringBootæ¡†æ¶çš„ä¸€ä¸ªæ¨¡å—ç”¨äºç›‘è§†å’Œç®¡ç†åº”ç”¨ç¨‹åº

## Gatewayï¼ˆæœåŠ¡ç½‘å…³ ï¼‰

> ä»¥å‰éƒ½æ˜¯ç”¨Zuulï¼Œä½†æ˜¯Zuulæ›´æ–°å¤ªæ°´äº†ï¼ŒSpring Cloud è‡ªå·±ç ”å‘äº†Gatewayæ›¿ä»£Zuul
>
> Spring Cloud Gatewayç»„ä»¶çš„æ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ï¼Œé€šè¿‡è¿™äº›è¿‡æ»¤å™¨å¯ä»¥å°†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚è½¬å‘(è·¯ç”±)åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚ Spring Cloud Gatewayæ˜¯åŠ åœ¨æ•´ä¸ªå¾®æœåŠ¡æœ€å‰æ²¿çš„é˜²ç«å¢™å’Œä»£ç†å™¨ï¼Œéšè—å¾®æœåŠ¡ç»“ç‚¹IPç«¯å£ä¿¡æ¯ï¼Œä»è€ŒåŠ å¼ºå®‰å…¨ä¿æŠ¤ã€‚Spring Cloud Gatewayæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œéœ€è¦æ³¨å†Œè¿›æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚

[Springå®˜æ–¹ä»‹ç»](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webmvc)

### ä¸‰å¤§æ ¸å¿ƒ

- è·¯ç”±ï¼ˆRouteï¼‰ï¼šç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ªIDã€ä¸€ä¸ªç›®æ ‡URIã€ä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºTrueï¼Œåˆ™åŒ¹é…è·¯ç”±ã€‚
- æ–­è¨€ï¼ˆPredicateï¼‰ï¼šå‚è€ƒçš„æ˜¯Java8ä¸­çš„java.util.function.Predicate,  å…è®¸åŒ¹é…HTTPè¯·æ±‚ä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚å¤´æˆ–å‚æ•°ã€‚å¦‚æœè¯·æ±‚ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”±ã€‚
- è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šæŒ‡çš„æ˜¯Springæ¡†æ¶ä¸­GatewayFilterçš„å®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…ä¹‹åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€‚

### Gatewayå·¥ä½œæµç¨‹

[å·¥ä½œæµç¨‹è¯´æ˜](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webmvc/how-it-works.html)

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚

è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰(Pre)æˆ–ä¹‹å(Post)æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚

åœ¨â€œpreâ€ç±»å‹çš„è¿‡æ»¤å™¨å¯ä»¥åšå‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒã€æµé‡ç›‘æ§ã€æ—¥å¿—è¾“å‡ºã€åè®®è½¬æ¢ç­‰;

åœ¨â€œpostâ€ç±»å‹çš„è¿‡æ»¤å™¨ä¸­å¯ä»¥åšå“åº”å†…å®¹ã€å“åº”å¤´çš„ä¿®æ”¹ï¼Œæ—¥å¿—çš„è¾“å‡ºï¼Œæµé‡ç›‘æ§ç­‰æœ‰ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚

æ ¸å¿ƒï¼šè·¯ç”±è½¬å‘ + æ–­è¨€åˆ¤æ–­ + æ‰§è¡Œè¿‡æ»¤å™¨é“¾

### Routeä»¥å¾®æœåŠ¡å - åŠ¨æ€è·å–æœåŠ¡URI

åœ¨é…ç½®routeçš„uriæ—¶ä½¿ç”¨ lb://æœåŠ¡å å³å¯

### Predicateæ–­è¨€

[Predicateæ–­è¨€è¯´æ˜](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webflux/request-predicates-factories.html)

Spring Cloudä¸­Gatewayæœ‰ä¸€ä¸ªRoutePredictFactoryï¼Œé€šè¿‡RoutePredicateå·¥å‚ç±»å¯ä»¥åˆ›å»ºPredictå¯¹è±¡ï¼ŒPredictå¯¹è±¡ç”¨äºRouteçš„åŒ¹é…ã€‚Spring Cloud Gatewayä¸­åŒ…å«å¤šä¸ªå†…ç½®çš„Route Predicate Factoriesï¼šAfterã€Beforeã€Betweenã€Cookieã€Headerã€Hostã€Methodã€Pathã€Queryã€ReadBodyã€RemoteAddrã€XForwardedRemoteAddrã€Weightã€CloudFoundryRouteServiceï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚

### Filterè¿‡æ»¤

[Filterè¿‡æ»¤è¯´æ˜](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webflux/gatewayfilter-factories.html)

åŠŸèƒ½ä¸Šç±»ä¼¼SpringMVCé‡Œçš„æ‹¦æˆªå™¨Interceptorï¼ŒServleté‡Œçš„è¿‡æ»¤å™¨

"pre"å’Œ"post"åˆ†åˆ«ä¼šåœ¨è¯·æ±‚è¢«æ‰§è¡Œå‰è°ƒç”¨å’Œè¢«æ‰§è¡Œåè°ƒç”¨ï¼Œç”¨æ¥ä¿®æ”¹è¯·æ±‚å’Œå“åº”ä¿¡æ¯

ä½œç”¨ï¼šè¯·æ±‚é‰´æƒã€å¼‚å¸¸å¤„ç†ã€è®°å½•æ¥å£è°ƒç”¨æ—¶é•¿ç»Ÿè®¡

è¿‡æ»¤å™¨åˆ†ç±»

- å•ä¸€å†…ç½®è¿‡æ»¤å™¨
- è‡ªå®šä¹‰è¿‡æ»¤å™¨
